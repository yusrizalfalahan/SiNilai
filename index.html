<!doctype html>
<html lang="id" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Nilai Kelas Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .overlay {
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .slide-in {
      animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .modal {
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .detail-panel {
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-panel.show {
      transform: translateX(0);
    }

    .progress-bar {
      transition: width 0.5s ease-in-out;
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%);
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(14, 165, 233, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(239, 68, 68, 0.3);
    }

    .input-field {
      transition: all 0.3s ease;
    }

    .input-field:focus {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
    }

    .menu-item {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .menu-item:hover::before {
      left: 100%;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: -400px;
      z-index: 1000;
      transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 350px;
    }

    .notification.show {
      right: 20px;
    }

    .auto-save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      transform: translateY(100px);
      transition: transform 0.3s ease;
    }

    .auto-save-indicator.show {
      transform: translateY(0);
    }

    .grade-excellent {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #166534;
      border: 1px solid #86efac;
    }

    .grade-good {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .grade-fair {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    .grade-poor {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .table-container {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .stats-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
    }

    .form-progress {
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
    }

    .form-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s ease;
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* Custom scrollbar untuk webkit browsers */
    nav::-webkit-scrollbar {
      width: 8px;
    }

    nav::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    nav::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    nav::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Custom scrollbar untuk Firefox */
    nav {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
</head>

<body class="h-full bg-gradient-to-br from-blue-50 via-white to-cyan-50 font-sans">
  <!-- Notification -->
  <div id="notification" class="notification bg-white border-l-4 border-green-500 p-4 rounded-lg shadow-lg">
    <div class="flex items-center">
      <svg class="w-6 h-6 text-green-500 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg><span id="notificationText" class="text-gray-800"></span>
    </div>
  </div><!-- Auto Save Indicator -->
  <div id="autoSaveIndicator" class="auto-save-indicator bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg">
    <div class="flex items-center text-sm">
      <svg class="w-5 h-5 mr-2" fill="currentColor" viewbox="0 0 20 20">
        <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path>
      </svg><span>Data disimpan otomatis</span>
    </div>
  </div><!-- Overlay -->
  <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40"></div><!-- Sidebar -->
  <div id="sidebar" class="sidebar fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 flex flex-col">
    <!-- Header - Fixed -->
    <div class="flex-shrink-0 p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewbox="0 0 20 20">
            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
          </svg>
          <div>
            <h2 class="text-xl font-bold text-gray-800">Menu Navigasi</h2>
            <p class="text-sm text-gray-500">Kelola data dengan mudah</p>
          </div>
        </div><button id="closeSidebar" class="text-gray-500 hover:text-gray-700 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg></button>
      </div>
    </div><!-- Menu - Scrollable -->
    <nav class="flex-1 overflow-y-auto p-6 space-y-3"><a href="#" onclick="showSection('dashboard')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
        </svg>
        <div><span class="font-medium">Dashboard</span>
          <p class="text-xs text-gray-500">Halaman utama</p>
        </div>
      </a> <a href="#" onclick="showSection('kelas')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
          <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"></path>
        </svg>
        <div><span class="font-medium">Data Kelas</span>
          <p class="text-xs text-gray-500">Kelola kelas sekolah</p>
        </div>
      </a> <a href="#" onclick="showSection('siswa')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
        </svg>
        <div><span class="font-medium">Data Siswa</span>
          <p class="text-xs text-gray-500">Kelola data siswa</p>
        </div>
      </a> <a href="#" onclick="showSection('nilai')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
        </svg>
        <div><span class="font-medium">Nilai Siswa</span>
          <p class="text-xs text-gray-500">Input dan kelola nilai</p>
        </div>
      </a> <a href="#" onclick="showSection('dashboard')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
        </svg>
        <div><span class="font-medium">Ranking Siswa</span>
          <p class="text-xs text-gray-500">Lihat peringkat nilai</p>
        </div>
      </a> <a href="#" onclick="showSection('pencarian')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
        </svg>
        <div><span class="font-medium">Filter Nilai</span>
          <p class="text-xs text-gray-500">Cari dan filter nilai</p>
        </div>
      </a> <a href="#" onclick="showSection('ekspor')" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-blue-50 text-gray-700 hover:text-blue-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <div><span class="font-medium">Ekspor Data</span>
          <p class="text-xs text-gray-500">Unduh laporan nilai</p>
        </div>
      </a> <a href="#" onclick="resetAllData()" class="menu-item flex items-center space-x-4 p-4 rounded-xl hover:bg-red-50 text-gray-700 hover:text-red-600 group">
        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor" viewbox="0 0 20 20">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <div><span class="font-medium">Reset Data</span>
          <p class="text-xs text-gray-500">Hapus semua data</p>
        </div>
      </a>
    </nav><!-- Footer - Fixed -->
    <div class="flex-shrink-0 p-6 border-t border-gray-200">
      <div class="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-200">
        <h3 class="font-semibold text-blue-900 mb-2">
          <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
            <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path>
          </svg> Penyimpanan
        </h3>
        <p class="text-sm text-blue-700">Data tersimpan otomatis di browser Anda dan tidak akan hilang saat refresh!</p>
      </div>
    </div>
  </div><!-- Detail Panel Overlay -->
  <div id="detailOverlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeDetailPanel()"></div><!-- Detail Panel -->
  <div id="detailPanel" class="detail-panel fixed right-0 top-0 h-full w-96 bg-white shadow-2xl z-50 overflow-y-auto">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">
          <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg> Detail Nilai Siswa
        </h3><button onclick="closeDetailPanel()" class="text-gray-500 hover:text-gray-700 text-2xl transition-colors">√ó</button>
      </div>
      <div id="detailContent">
        <!-- Detail content will be populated here -->
      </div>
    </div>
  </div><!-- Main Content -->
  <div class="h-full">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm shadow-sm border-b border-gray-200 sticky top-0 z-30">
      <div class="px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center space-x-4"><button id="menuToggle" class="text-gray-600 hover:text-blue-600 text-2xl transition-colors hover:scale-110">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg></button>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent flex items-center gap-2">
                <svg class="w-7 h-7 text-blue-600" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                </svg> Daftar Nilai Kelas Digital
              </h1>
              <p class="text-sm text-gray-500 hidden sm:block">Kelola nilai siswa dengan mudah, cepat, dan efisien</p>
            </div>
          </div>
          <div class="flex items-center space-x-4"><select id="semesterSelect" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
              <option value="ganjil">üåô Semester Ganjil</option>
              <option value="genap">‚òÄÔ∏è Semester Genap</option>
            </select>
          </div>
        </div>
      </div>
    </header><!-- Main Content Area -->
    <main class="px-4 sm:px-6 lg:px-8 py-8">
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="section fade-in">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-900 mb-4">
            <svg class="w-10 h-10 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
              <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
            </svg> Daftar Nilai Kelas Digital
          </h2>
          <p class="text-xl text-gray-600 mb-8">Kelola nilai siswa dengan mudah, cepat, dan efisien</p><!-- Quick Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
            <div class="stats-card p-6 rounded-2xl text-center card-hover">
              <div class="text-3xl font-bold text-blue-600 mb-2" id="dashTotalKelas">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                  <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"></path>
                </svg> Total Kelas
              </div>
            </div>
            <div class="stats-card p-6 rounded-2xl text-center card-hover">
              <div class="text-3xl font-bold text-green-600 mb-2" id="dashTotalSiswa">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                </svg> Total Siswa
              </div>
            </div>
            <div class="stats-card p-6 rounded-2xl text-center card-hover">
              <div class="text-3xl font-bold text-purple-600 mb-2" id="dashTotalNilai">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                  <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                </svg> Total Nilai
              </div>
            </div>
            <div class="stats-card p-6 rounded-2xl text-center card-hover">
              <div class="text-3xl font-bold text-orange-600 mb-2" id="dashRataRata">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                </svg> Rata-rata
              </div>
            </div>
          </div>
        </div><!-- Ranking Section -->
        <div class="mb-8">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
            <div>
              <h3 class="text-2xl font-bold text-gray-900">
                <svg class="w-8 h-8 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg> Peringkat Siswa
              </h3>
              <p class="text-gray-600">Urutan berdasarkan rata-rata nilai tertinggi</p>
            </div>
            <div class="flex gap-3 mt-4 sm:mt-0"><select id="rankingKelasFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white shadow-sm" onchange="renderDashboard()">
                <option value="">üìö Semua Kelas</option>
              </select> <select id="rankingCountFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white shadow-sm" onchange="renderDashboard()">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="50">Top 50</option>
                <option value="all">Semua</option>
              </select>
            </div>
          </div><!-- Top 3 Podium -->
          <div id="podiumContainer" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <!-- Podium will be rendered here -->
          </div>
        </div><!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="card-hover bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border border-blue-200">
            <div class="text-center">
              <div class="text-4xl mb-4">
                <svg class="w-16 h-16 mx-auto text-blue-600" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-blue-900 mb-2">Kelola Kelas</h3>
              <p class="text-blue-700 text-sm mb-4">Tambah dan atur kelas sekolah</p><button onclick="showSection('kelas')" class="btn-primary text-white px-6 py-2 rounded-xl font-medium w-full"> Buka Kelas </button>
            </div>
          </div>
          <div class="card-hover bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-2xl border border-green-200">
            <div class="text-center">
              <div class="text-4xl mb-4">
                <svg class="w-16 h-16 mx-auto text-green-600" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-green-900 mb-2">Data Siswa</h3>
              <p class="text-green-700 text-sm mb-4">Kelola informasi siswa</p><button onclick="showSection('siswa')" class="btn-success text-white px-6 py-2 rounded-xl font-medium w-full"> Buka Siswa </button>
            </div>
          </div>
          <div class="card-hover bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-2xl border border-purple-200">
            <div class="text-center">
              <div class="text-4xl mb-4">
                <svg class="w-16 h-16 mx-auto text-purple-600" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-purple-900 mb-2">Input Nilai</h3>
              <p class="text-purple-700 text-sm mb-4">Masukkan dan kelola nilai</p><button onclick="showSection('nilai')" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-2 rounded-xl font-medium w-full transition-all"> Buka Nilai </button>
            </div>
          </div>
        </div><!-- Ranking Table -->
        <div class="table-container">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">
              <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
              </svg> Daftar Peringkat Lengkap
            </h3>
            <p class="text-gray-600 text-sm">Urutan siswa berdasarkan nilai rata-rata tertinggi ke terendah</p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peringkat</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rata-rata</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                </tr>
              </thead>
              <tbody id="dashboardTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Dashboard data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div><!-- Kelas Section -->
      <div id="kelasSection" class="section hidden">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
          <div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              <svg class="w-8 h-8 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
              </svg> Manajemen Kelas
            </h2>
            <p class="text-gray-600">Kelola data kelas sekolah dengan mudah</p>
          </div><button onclick="openModal('kelasModal')" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg mt-4 sm:mt-0"> ÔøΩÔøΩÔøΩ Tambah Kelas Baru </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="kelasContainer">
          <!-- Kelas cards will be populated here -->
        </div>
      </div><!-- Siswa Section -->
      <div id="siswaSection" class="section hidden">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
          <div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              <svg class="w-8 h-8 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
              </svg> Data Siswa
            </h2>
            <p class="text-gray-600">Kelola informasi siswa di setiap kelas</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 mt-4 sm:mt-0"><select id="kelasFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white shadow-sm">
              <option value="">üìö Semua Kelas</option>
            </select> <button onclick="downloadTemplateImport()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-xl font-medium shadow-lg transition-all"> üìÑ Template Import </button> <button onclick="importSiswa()" class="btn-success text-white px-6 py-3 rounded-xl font-medium shadow-lg"> üì• Import Excel/CSV </button> <button onclick="openModal('siswaModal')" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg"> ‚ûï Tambah Siswa </button>
          </div>
        </div>
        <div class="table-container">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                </tr>
              </thead>
              <tbody id="siswaTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Siswa data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div><!-- Nilai Section -->
      <div id="nilaiSection" class="section hidden">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
          <div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              <svg class="w-8 h-8 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
              </svg> Nilai Siswa
            </h2>
            <p class="text-gray-600">Input dan kelola nilai dengan sistem perhitungan otomatis</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 mt-4 sm:mt-0"><select id="kelasNilaiFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white shadow-sm">
              <option value="">üìö Pilih Kelas</option>
            </select> <button onclick="openModal('kolomModal')" class="btn-success text-white px-6 py-3 rounded-xl font-medium shadow-lg"> ‚ûï Tambah Kolom </button>
          </div>
        </div>
        <div class="table-container overflow-x-auto">
          <table class="w-full min-w-max">
            <thead class="bg-gray-50">
              <tr id="nilaiTableHeader">
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Nama Siswa</th><!-- Dynamic columns will be added here -->
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Akhir (%)</th>
              </tr>
            </thead>
            <tbody id="nilaiTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Nilai data will be populated here -->
            </tbody>
          </table>
        </div>
      </div><!-- Pencarian Section -->
      <div id="pencarianSection" class="section hidden">
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">
            <svg class="w-8 h-8 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
            </svg> Filter &amp; Pencarian Nilai
          </h2>
          <p class="text-gray-600">Cari dan filter data nilai berdasarkan kriteria tertentu</p>
        </div><!-- Filter Form -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-6">
            <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
            </svg> Filter Data
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üóìÔ∏è Tanggal Mulai</label> <input type="date" id="tanggalMulai" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üóìÔ∏è Tanggal Akhir</label> <input type="date" id="tanggalAkhir" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üë§ Nama Siswa</label> <input type="text" id="filterNamaSiswa" placeholder="Cari nama siswa..." class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üìö Kelas</label> <select id="filterKelas" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                <option value="">Semua Kelas</option>
              </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üìù Jenis Nilai</label> <select id="filterJenisNilai" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                <option value="">Semua Jenis</option>
              </select>
            </div>
            <div class="flex items-end"><button onclick="applyFilter()" class="btn-primary w-full text-white px-6 py-3 rounded-xl font-medium shadow-lg"> üîç Terapkan Filter </button>
            </div>
          </div>
        </div><!-- Filter Results -->
        <div id="filterResults" class="hidden">
          <div class="table-container">
            <div class="p-6 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">
                <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg> Hasil Pencarian
              </h3>
              <p class="text-gray-600 text-sm">Satu baris per siswa - klik Detail untuk melihat nilai lengkap</p>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rata-rata</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                  </tr>
                </thead>
                <tbody id="filterTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- Filtered results will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- Ekspor Section -->
      <div id="eksporSection" class="section hidden">
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">
            <svg class="w-8 h-8 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg> Ekspor &amp; Laporan Nilai
          </h2>
          <p class="text-gray-600">Unduh laporan nilai dalam berbagai format</p>
        </div><!-- Export Ranking Form -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 mb-8">
          <div class="text-center mb-6">
            <div class="text-5xl mb-3">
              <svg class="w-20 h-20 mx-auto text-yellow-500" fill="currentColor" viewbox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Export Ranking Siswa</h3>
            <p class="text-gray-600">Unduh daftar peringkat siswa dengan filter kustom</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üè´ Pilih Kelas</label> <select id="exportKelasSelect" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">üìö Semua Kelas</option>
              </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Tahun Ajaran</label> <input type="text" id="exportTahunAjaran" placeholder="Contoh: 2023/2024" value="2023/2024" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üìä Urutan Data</label> <select id="exportSortType" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="ranking">üèÜ Berdasarkan Ranking (Nilai Tertinggi)</option>
                <option value="abjad">üî§ Berdasarkan Abjad (A-Z)</option>
              </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">üìù Jenis Nilai</label>
              <div id="exportNilaiCheckboxes" class="space-y-2 border border-gray-300 rounded-xl p-4 max-h-48 overflow-y-auto bg-gray-50">
                <!-- Checkboxes will be populated here -->
              </div>
            </div>
            <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">üìã Judul Laporan</label> <input type="text" id="exportJudulLaporan" placeholder="Contoh: Daftar Nilai UTS" value="Daftar Nilai Semester" class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white mb-3"> <label class="block text-sm font-medium text-gray-700 mb-2">üî¢ Tambahkan NIS</label>
              <div class="flex items-center space-x-3"><label class="flex items-center cursor-pointer"> <input type="checkbox" id="exportTambahNIS" checked class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"> <span class="ml-2 text-sm text-gray-700">Sertakan kolom NIS</span> </label>
              </div>
            </div>
          </div>
          <div class="flex gap-4"><button onclick="exportRankingExcel()" class="flex-1 btn-primary text-white px-8 py-4 rounded-xl font-medium shadow-lg"> üìä Export ke Excel </button> <button onclick="exportRankingCSV()" class="flex-1 btn-success text-white px-8 py-4 rounded-xl font-medium shadow-lg"> ÔøΩÔøΩ Export ke CSV </button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div class="card-hover bg-gradient-to-br from-blue-50 to-blue-100 p-8 rounded-2xl border border-blue-200">
            <div class="text-center">
              <div class="text-6xl mb-4">
                <svg class="w-24 h-24 mx-auto text-blue-600" fill="currentColor" viewbox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-blue-900 mb-4">Ekspor Lengkap (Excel)</h3>
              <p class="text-blue-700 mb-6">Unduh laporan lengkap dengan sheet terpisah per kelas, format otomatis rapi, dan rekap keseluruhan</p>
              <div class="text-sm text-blue-600 mb-4">
                ÔøΩÔøΩÔøΩ Sheet per kelas<br>
                ‚úÖ Format tabel otomatis<br>
                ‚úÖ Rekap keseluruhan<br>
                ‚úÖ Color coding nilai
              </div><button onclick="eksporExcel()" class="btn-primary text-white px-8 py-4 rounded-xl font-medium shadow-lg w-full"> üì• Download Excel Lengkap </button>
            </div>
          </div>
          <div class="card-hover bg-gradient-to-br from-green-50 to-green-100 p-8 rounded-2xl border border-green-200">
            <div class="text-center">
              <div class="text-6xl mb-4">
                <svg class="w-24 h-24 mx-auto text-green-600" fill="currentColor" viewbox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-green-900 mb-4">Ekspor Semua Nilai (CSV)</h3>
              <p class="text-green-700 mb-6">Unduh semua data nilai dalam format CSV untuk Google Sheets dan aplikasi lainnya</p><button onclick="eksporCSV()" class="btn-success text-white px-8 py-4 rounded-xl font-medium shadow-lg w-full"> üì• Download CSV Lengkap </button>
            </div>
          </div>
        </div><!-- Statistics -->
        <div class="stats-card p-8 rounded-2xl">
          <h4 class="text-xl font-semibold text-gray-900 mb-6 text-center">
            <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewbox="0 0 20 20">
              <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
            </svg> Ringkasan Data Sekolah
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div class="text-center">
              <div class="text-4xl font-bold text-blue-600 mb-2" id="totalKelas">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
                </svg> Total Kelas
              </div>
            </div>
            <div class="text-center">
              <div class="text-4xl font-bold text-green-600 mb-2" id="totalSiswa">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                </svg> Total Siswa
              </div>
            </div>
            <div class="text-center">
              <div class="text-4xl font-bold text-purple-600 mb-2" id="totalNilai">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                  <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                </svg> Total Nilai
              </div>
            </div>
            <div class="text-center">
              <div class="text-4xl font-bold text-orange-600 mb-2" id="rataRata">
                0
              </div>
              <div class="text-sm text-gray-600">
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewbox="0 0 20 20">
                  <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                </svg> Rata-rata
              </div>
            </div>
          </div>
        </div>
      </div>
    </main><!-- Footer -->
    <footer class="bg-white/90 backdrop-blur-sm border-t border-gray-200 py-6 mt-12">
      <div class="px-4 sm:px-6 lg:px-8">
        <p class="text-center text-gray-600">‚ú® Dibuat untuk kemudahan guru mengelola nilai siswa dengan teknologi modern</p>
      </div>
    </footer>
  </div><!-- Modals -->
  <!-- Kelas Modal -->
  <div id="kelasModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
      <div class="text-center mb-6">
        <div class="text-5xl mb-4">
          <svg class="w-20 h-20 mx-auto text-blue-600" fill="currentColor" viewbox="0 0 20 20">
            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900" id="kelasModalTitle">Tambah Kelas Baru</h3>
        <p class="text-gray-600">Masukkan informasi kelas</p>
      </div><!-- Progress Bar -->
      <div class="form-progress mb-6">
        <div class="form-progress-bar" id="kelasProgress" style="width: 0%"></div>
      </div>
      <form id="kelasForm" onsubmit="submitKelas(event)"><input type="hidden" id="kelasId" value="">
        <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üìò Nama Kelas</label> <input type="text" id="namaKelas" placeholder="Contoh: X IPA 1" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" oninput="updateFormProgress('kelas')">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üéì Tingkat</label> <select id="tingkatKelas" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateFormProgress('kelas')">
              <option value="">Pilih Tingkat</option>
              <option value="VII">Kelas VII</option>
              <option value="VIII">Kelas VIII</option>
              <option value="IX">Kelas IX</option>
            </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üë®‚Äçüè´ Nama Wali Kelas</label> <input type="text" id="waliKelas" placeholder="Contoh: Budi Santoso, S.Pd" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" oninput="updateFormProgress('kelas')">
          </div>
        </div>
        <div class="flex space-x-4 mt-8"><button type="button" onclick="closeModal('kelasModal')" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors"> Batal </button> <button type="submit" class="btn-primary flex-1 text-white px-6 py-3 rounded-xl font-medium"> ‚ú® Simpan Kelas </button>
        </div>
      </form>
    </div>
  </div><!-- Siswa Modal -->
  <div id="siswaModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
      <div class="text-center mb-6">
        <div class="text-5xl mb-4">
          <svg class="w-20 h-20 mx-auto text-green-600" fill="currentColor" viewbox="0 0 20 20">
            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900" id="siswaModalTitle">Tambah Siswa Baru</h3>
        <p class="text-gray-600">Masukkan data siswa</p>
      </div><!-- Progress Bar -->
      <div class="form-progress mb-6">
        <div class="form-progress-bar" id="siswaProgress" style="width: 0%"></div>
      </div>
      <form id="siswaForm" onsubmit="submitSiswa(event)"><input type="hidden" id="siswaId" value="">
        <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üî¢ NIS (Nomor Induk Siswa)</label> <input type="text" id="nisSiswa" placeholder="Masukkan NIS" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" oninput="updateFormProgress('siswa')">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üë§ Nama Siswa</label> <input type="text" id="namaSiswa" placeholder="Masukkan nama lengkap" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" oninput="updateFormProgress('siswa')">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üè´ Kelas</label> <select id="kelasSiswa" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateFormProgress('siswa')">
              <option value="">Pilih Kelas</option>
            </select>
          </div>
        </div>
        <div class="flex space-x-4 mt-8"><button type="button" onclick="closeModal('siswaModal')" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors"> Batal </button> <button type="submit" class="btn-primary flex-1 text-white px-6 py-3 rounded-xl font-medium"> ‚ú® Simpan Siswa </button>
        </div>
      </form>
    </div>
  </div><!-- Kolom Modal -->
  <div id="kolomModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
      <div class="text-center mb-6">
        <div class="text-5xl mb-4">
          <svg class="w-20 h-20 mx-auto text-purple-600" fill="currentColor" viewbox="0 0 20 20">
            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900" id="kolomModalTitle">Tambah Kolom Nilai</h3>
        <p class="text-gray-600">Buat jenis penilaian baru</p>
      </div><!-- Progress Bar -->
      <div class="form-progress mb-6">
        <div class="form-progress-bar" id="kolomProgress" style="width: 0%"></div>
      </div>
      <form id="kolomForm" onsubmit="submitKolom(event)"><input type="hidden" id="oldKolomNama" value="">
        <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üìù Nama Jenis Nilai</label> <input type="text" id="namaKolom" placeholder="Contoh: Tugas 2, Quiz, Proyek" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" oninput="updateFormProgress('kolom')">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üóìÔ∏è Tanggal Penilaian</label> <input type="date" id="tanggalKolom" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateFormProgress('kolom')">
          </div>
        </div>
        <div class="flex space-x-4 mt-8"><button type="button" onclick="closeModal('kolomModal')" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors"> Batal </button> <button type="submit" id="kolomSubmitBtn" class="btn-success flex-1 text-white px-6 py-3 rounded-xl font-medium"> ‚ûï Tambah Kolom </button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Data Storage with localStorage
    class DataManager {
      constructor() {
        this.storageKey = 'nilaiKelasDigital';
        this.loadData();
      }

      loadData() {
        const stored = localStorage.getItem(this.storageKey);
        if (stored) {
          this.data = JSON.parse(stored);
        } else {
          this.initDefaultData();
        }
      }

      saveData() {
        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
        this.showAutoSaveIndicator();
      }

      initDefaultData() {
        this.data = {
          kelas: [{
              id: 1,
              nama: 'VII A',
              tingkat: 'VII',
              waliKelas: 'Ahmad Budiman, S.Pd'
            },
            {
              id: 2,
              nama: 'VII B',
              tingkat: 'VII',
              waliKelas: 'Siti Rahayu, S.Pd'
            },
            {
              id: 3,
              nama: 'VIII A',
              tingkat: 'VIII',
              waliKelas: 'Drs. Bambang Susilo'
            }
          ],
          siswa: [{
              id: 1,
              nama: 'Ahmad Rizki Pratama',
              kelasId: 1,
              nis: '2023001'
            },
            {
              id: 2,
              nama: 'Siti Nurhaliza Putri',
              kelasId: 1,
              nis: '2023002'
            },
            {
              id: 3,
              nama: 'Budi Santoso',
              kelasId: 1,
              nis: '2023003'
            },
            {
              id: 4,
              nama: 'Dewi Sartika',
              kelasId: 2,
              nis: '2023004'
            },
            {
              id: 5,
              nama: 'Eko Prasetyo',
              kelasId: 2,
              nis: '2023005'
            },
            {
              id: 6,
              nama: 'Fatimah Zahra',
              kelasId: 3,
              nis: '2023006'
            },
            {
              id: 7,
              nama: 'Galih Pratama',
              kelasId: 3,
              nis: '2023007'
            }
          ],
          nilai: [{
              siswaId: 1,
              semester: 'ganjil',
              'Tugas 1': 85,
              'Ulangan Harian': 78,
              'UTS': 82,
              'UAS': 88,
              tanggal: '2024-01-15'
            },
            {
              siswaId: 2,
              semester: 'ganjil',
              'Tugas 1': 92,
              'Ulangan Harian': 89,
              'UTS': 91,
              'UAS': 94,
              tanggal: '2024-01-15'
            },
            {
              siswaId: 3,
              semester: 'ganjil',
              'Tugas 1': 76,
              'Ulangan Harian': 73,
              'UTS': 79,
              'UAS': 81,
              tanggal: '2024-01-15'
            },
            {
              siswaId: 4,
              semester: 'ganjil',
              'Tugas 1': 88,
              'Ulangan Harian': 85,
              'UTS': 87,
              'UAS': 90,
              tanggal: '2024-01-15'
            },
            {
              siswaId: 5,
              semester: 'ganjil',
              'Tugas 1': 79,
              'Ulangan Harian': 82,
              'UTS': 80,
              'UAS': 83,
              tanggal: '2024-01-15'
            },
            {
              siswaId: 6,
              semester: 'ganjil',
              'Tugas 1': 95,
              'Ulangan Harian': 93,
              'UTS': 96,
              'UAS': 97,
              tanggal: '2024-01-15'
            },
            {
              siswaId: 7,
              semester: 'ganjil',
              'Tugas 1': 72,
              'Ulangan Harian': 75,
              'UTS': 74,
              'UAS': 78,
              tanggal: '2024-01-15'
            }
          ],
          kolomNilai: [{
              nama: 'Tugas 1',
              tanggal: '2024-01-15'
            },
            {
              nama: 'Ulangan Harian',
              tanggal: '2024-01-20'
            },
            {
              nama: 'UTS',
              tanggal: '2024-02-15'
            },
            {
              nama: 'UAS',
              tanggal: '2024-03-15'
            }
          ],
          currentSemester: 'ganjil'
        };
        this.saveData();
      }

      showAutoSaveIndicator() {
        const indicator = document.getElementById('autoSaveIndicator');
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
      }

      resetAllData() {
        if (confirm('‚ö†Ô∏è Yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
          localStorage.removeItem(this.storageKey);
          this.initDefaultData();
          showNotification('üîÑ Semua data berhasil direset!');
          setTimeout(() => {
            location.reload();
          }, 1000);
        }
      }
    }

    // Reset all data function
    function resetAllData() {
      dataManager.resetAllData();
    }

    // Initialize data manager
    const dataManager = new DataManager();
    let data = dataManager.data;

    // Notification system
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const text = document.getElementById('notificationText');

      text.textContent = message;

      // Change color based on type
      notification.className = 'notification bg-white border-l-4 p-4 rounded-lg shadow-lg';
      if (type === 'success') {
        notification.classList.add('border-green-500');
      } else if (type === 'error') {
        notification.classList.add('border-red-500');
      } else if (type === 'info') {
        notification.classList.add('border-blue-500');
      }

      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Form progress tracking
    function updateFormProgress(formType) {
      let progress = 0;
      let totalFields = 0;
      let filledFields = 0;

      if (formType === 'kelas') {
        totalFields = 3;
        if (document.getElementById('namaKelas').value) filledFields++;
        if (document.getElementById('tingkatKelas').value) filledFields++;
        if (document.getElementById('waliKelas').value) filledFields++;
      } else if (formType === 'siswa') {
        totalFields = 3;
        if (document.getElementById('nisSiswa').value) filledFields++;
        if (document.getElementById('namaSiswa').value) filledFields++;
        if (document.getElementById('kelasSiswa').value) filledFields++;
      } else if (formType === 'kolom') {
        totalFields = 2;
        if (document.getElementById('namaKolom').value) filledFields++;
        if (document.getElementById('tanggalKolom').value) filledFields++;
      }

      progress = (filledFields / totalFields) * 100;
      document.getElementById(formType + 'Progress').style.width = progress + '%';
    }

    // Sidebar functionality
    function initializeSidebar() {
      const menuToggle = document.getElementById('menuToggle');
      const closeSidebarBtn = document.getElementById('closeSidebar');
      const overlay = document.getElementById('overlay');

      if (menuToggle) {
        menuToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          document.getElementById('sidebar').classList.add('open');
          document.getElementById('overlay').classList.add('show');
        });
      }

      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', closeSidebar);
      }

      if (overlay) {
        overlay.addEventListener('click', closeSidebar);
      }
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('show');
    }

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      initializeSidebar();

      // Semester change handler
      const semesterSelect = document.getElementById('semesterSelect');
      if (semesterSelect) {
        semesterSelect.addEventListener('change', function() {
          data.currentSemester = this.value;
          dataManager.saveData();
          showNotification(`Semester diubah ke ${this.value}`, 'info');
          renderDashboard();
        });
      }

      // Kelas filter change handlers
      const kelasFilter = document.getElementById('kelasFilter');
      if (kelasFilter) {
        kelasFilter.addEventListener('change', renderSiswa);
      }

      const kelasNilaiFilter = document.getElementById('kelasNilaiFilter');
      if (kelasNilaiFilter) {
        kelasNilaiFilter.addEventListener('change', renderNilai);
      }



      // Initialize dashboard
      showSection('dashboard');
    });

    // Modal functionality
    function openModal(modalId, editData = null) {
      const modal = document.getElementById(modalId);
      modal.classList.add('show');

      // Populate kelas options for siswa modal
      if (modalId === 'siswaModal') {
        const kelasSelect = document.getElementById('kelasSiswa');
        kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>';
        data.kelas.forEach(kelas => {
          kelasSelect.innerHTML += `<option value="${kelas.id}">${kelas.nama}</option>`;
        });

        // If editing, populate form
        if (editData) {
          document.getElementById('siswaModalTitle').textContent = 'Edit Data Siswa';
          document.getElementById('siswaId').value = editData.id;
          document.getElementById('nisSiswa').value = editData.nis || '';
          document.getElementById('namaSiswa').value = editData.nama;
          document.getElementById('kelasSiswa').value = editData.kelasId;
          updateFormProgress('siswa');
        } else {
          document.getElementById('siswaModalTitle').textContent = 'Tambah Siswa Baru';
        }
      }

      // If editing kelas
      if (modalId === 'kelasModal' && editData) {
        document.getElementById('kelasModalTitle').textContent = 'Edit Data Kelas';
        document.getElementById('kelasId').value = editData.id;
        document.getElementById('namaKelas').value = editData.nama;
        document.getElementById('tingkatKelas').value = editData.tingkat;
        document.getElementById('waliKelas').value = editData.waliKelas || '';
        updateFormProgress('kelas');
      } else if (modalId === 'kelasModal') {
        document.getElementById('kelasModalTitle').textContent = 'Tambah Kelas Baru';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');

      // Reset forms and progress
      const form = modal.querySelector('form');
      if (form) form.reset();

      const progressBar = modal.querySelector('.form-progress-bar');
      if (progressBar) progressBar.style.width = '0%';

      // Reset hidden fields
      const hiddenInputs = modal.querySelectorAll('input[type="hidden"]');
      hiddenInputs.forEach(input => input.value = '');

      // Reset modal titles and buttons
      if (modalId === 'kolomModal') {
        document.getElementById('kolomModalTitle').textContent = 'Tambah Kolom Nilai';
        document.getElementById('kolomSubmitBtn').innerHTML = '‚ûï Tambah Kolom';
      }
    }

    // Detail Panel functionality
    function showDetailPanel(siswaId) {
      const siswa = data.siswa.find(s => s.id === siswaId);
      const kelas = data.kelas.find(k => k.id === siswa.kelasId);
      const nilai = data.nilai.find(n => n.siswaId === siswaId && n.semester === data.currentSemester);

      if (!siswa) {
        showNotification('Data siswa tidak ditemukan!', 'error');
        return;
      }

      // Show overlay
      document.getElementById('detailOverlay').classList.add('show');

      const content = document.getElementById('detailContent');

      // Calculate statistics
      let totalNilaiSum = 0;
      let jumlahKolom = 0;
      let nilaiTertinggi = 0;
      let nilaiTerendah = 100;

      const nilaiData = [];

      if (nilai) {
        data.kolomNilai.forEach(kolom => {
          if (nilai[kolom.nama] !== undefined) {
            const nilaiKolom = parseFloat(nilai[kolom.nama]) || 0;
            nilaiData.push({
              nama: kolom.nama,
              nilai: nilaiKolom,
              tanggal: kolom.tanggal
            });

            // Hitung semua nilai termasuk nilai 0
            totalNilaiSum += nilaiKolom;
            jumlahKolom++;
            nilaiTertinggi = Math.max(nilaiTertinggi, nilaiKolom);

            // Untuk nilai terendah, hitung dari semua nilai yang ada
            if (jumlahKolom === 1) {
              nilaiTerendah = nilaiKolom;
            } else {
              nilaiTerendah = Math.min(nilaiTerendah, nilaiKolom);
            }
          }
        });
      }

      const nilaiRataRata = jumlahKolom > 0 ? (totalNilaiSum / jumlahKolom).toFixed(1) : 0;
      const gradeClass = getGradeClass(nilaiRataRata);
      const gradeText = getGradeText(nilaiRataRata);

      if (jumlahKolom === 0) {
        nilaiTerendah = 0;
      }

      content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">
                        <svg class="w-16 h-16 mx-auto text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 mb-1">${siswa.nama}</h4>
                    <p class="text-gray-600">${kelas ? kelas.nama : 'Tidak ada'} ‚Ä¢ Semester ${data.currentSemester}</p>
                </div>
                
                <!-- Statistics -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="stats-card p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold ${gradeClass.replace('bg-', 'text-').replace('-50', '-600')} mb-1">${nilaiRataRata}</div>
                        <div class="text-xs text-gray-600">üéØ Rata-rata</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-purple-600 mb-1">${Math.round(totalNilaiSum)}</div>
                        <div class="text-xs text-gray-600">‚ûï Total Nilai</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-green-600 mb-1">${nilaiTertinggi}</div>
                        <div class="text-xs text-gray-600">‚¨ÜÔ∏è Tertinggi</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-red-600 mb-1">${nilaiTerendah}</div>
                        <div class="text-xs text-gray-600">‚¨áÔ∏è Terendah</div>
                    </div>
                </div>
                
                <!-- Grade Status -->
                <div class="mb-6">
                    <div class="${gradeClass} p-4 rounded-xl text-center">
                        <div class="font-semibold mb-1">${gradeText}</div>
                        <div class="text-sm opacity-80">${((nilaiRataRata / 100) * 100).toFixed(0)}% dari target</div>
                    </div>
                </div>
                
                <!-- Detailed Grades -->
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-900 mb-3">
                        <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Rincian Nilai
                    </h5>
                    ${nilaiData.map(item => {
                        const itemGradeClass = getGradeClass(item.nilai);
                        return `
                            <div class="card-hover ${itemGradeClass} p-3 rounded-xl">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium text-sm">${item.nama}</span>
                                    <span class="text-lg font-bold">${item.nilai}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs opacity-75">
                                    <span>üìÖ ${item.tanggal}</span>
                                    <span>${getGradeText(item.nilai)}</span>
                                </div>
                                <div class="mt-2">
                                    <div class="w-full bg-white bg-opacity-50 rounded-full h-1.5">
                                        <div class="progress-bar h-1.5 rounded-full ${itemGradeClass.includes('green') ? 'bg-green-600' : itemGradeClass.includes('blue') ? 'bg-blue-600' : itemGradeClass.includes('yellow') ? 'bg-yellow-600' : 'bg-red-600'}" style="width: ${item.nilai}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                ${jumlahKolom === 0 ? '<div class="text-center text-gray-500 py-6">Belum ada data nilai</div>' : ''}
            `;

      document.getElementById('detailPanel').classList.add('show');
    }

    function closeDetailPanel() {
      document.getElementById('detailPanel').classList.remove('show');
      document.getElementById('detailOverlay').classList.remove('show');
    }

    // Section navigation
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });

      // Show selected section
      document.getElementById(sectionName + 'Section').classList.remove('hidden');

      // Update content based on section
      switch (sectionName) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'kelas':
          renderKelas();
          break;
        case 'siswa':
          renderSiswa();
          updateKelasFilters();
          break;
        case 'nilai':
          renderNilai();
          updateKelasFilters();
          break;
        case 'pencarian':
          updateFilterOptions();
          break;
        case 'ekspor':
          updateStatistics();
          updateExportOptions();
          break;
      }

      closeSidebar();
    }

    // Calculate student average
    function calculateStudentAverage(siswaId) {
      const nilai = data.nilai.find(n => n.siswaId === siswaId && n.semester === data.currentSemester);

      if (!nilai) return 0;

      // Jika tidak ada kolom nilai sama sekali
      if (data.kolomNilai.length === 0) return 0;

      let totalNilai = 0;
      let jumlahKolom = 0;

      // Hitung SEMUA kolom nilai yang ada, termasuk nilai 0
      data.kolomNilai.forEach(kolom => {
        if (nilai[kolom.nama] !== undefined) {
          totalNilai += parseFloat(nilai[kolom.nama]) || 0;
          jumlahKolom++;
        }
      });

      return jumlahKolom > 0 ? parseFloat((totalNilai / jumlahKolom).toFixed(1)) : 0;
    }

    // Get ranked students
    function getRankedStudents(kelasFilter = '') {
      let filteredSiswa = data.siswa;

      if (kelasFilter) {
        filteredSiswa = data.siswa.filter(s => s.kelasId == kelasFilter);
      }

      // Calculate averages and create ranking array
      const rankedStudents = filteredSiswa.map(siswa => {
        const kelas = data.kelas.find(k => k.id === siswa.kelasId);
        const average = calculateStudentAverage(siswa.id);

        return {
          siswaId: siswa.id,
          nama: siswa.nama,
          kelas: kelas,
          average: average
        };
      });

      // Sort by average (highest to lowest), then by name for ties
      rankedStudents.sort((a, b) => {
        if (b.average !== a.average) {
          return b.average - a.average;
        }
        return a.nama.localeCompare(b.nama);
      });

      return rankedStudents;
    }

    // Dashboard functionality
    function renderDashboard() {
      updateDashboardStats();
      updateRankingKelasFilter();

      const kelasFilter = document.getElementById('rankingKelasFilter').value;
      const countFilter = document.getElementById('rankingCountFilter').value;

      const rankedStudents = getRankedStudents(kelasFilter);

      // Render podium (top 3)
      renderPodium(rankedStudents.slice(0, 3));

      // Render table
      const tbody = document.getElementById('dashboardTableBody');
      tbody.innerHTML = '';

      const displayCount = countFilter === 'all' ? rankedStudents.length : parseInt(countFilter);
      const displayStudents = rankedStudents.slice(0, displayCount);

      displayStudents.forEach((student, index) => {
        const rank = index + 1;
        const gradeClass = getGradeClass(student.average);
        const gradeText = getGradeText(student.average);

        // Medal for top 3 using SVG
        let rankDisplay = `<span class="text-lg font-bold">${rank}</span>`;
        if (rank === 1) {
          rankDisplay = '<div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">1</div>';
        } else if (rank === 2) {
          rankDisplay = '<div class="w-8 h-8 bg-gradient-to-br from-gray-300 to-gray-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">2</div>';
        } else if (rank === 3) {
          rankDisplay = '<div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">3</div>';
        }

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';

        // Highlight top 3
        if (rank <= 3) {
          row.className += ' bg-gradient-to-r from-yellow-50 to-amber-50';
        }

        row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="text-lg font-bold text-gray-900">${rankDisplay}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${student.nama}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${student.kelas ? student.kelas.nama : 'Tidak ada'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${data.currentSemester === 'ganjil' ? 'üåô Ganjil' : '‚òÄÔ∏è Genap'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-2xl ${gradeClass.replace('grade-', 'text-').replace('excellent', 'green-600').replace('good', 'blue-600').replace('fair', 'yellow-600').replace('poor', 'red-600')}">
                            ${student.average}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="${gradeClass} px-3 py-1.5 rounded-lg text-xs font-medium">
                            ${gradeText}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="showDetailPanel(${student.siswaId})" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-3 py-1.5 rounded-lg font-medium text-sm transition-all">
                            üîç Detail
                        </button>
                    </td>
                `;
        tbody.appendChild(row);
      });

      if (displayStudents.length === 0) {
        tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <div class="text-4xl mb-4">
                                <svg class="w-16 h-16 mx-auto text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                                </svg>
                            </div>
                            <div class="text-lg">Belum ada data siswa</div>
                            <div class="text-sm">Tambahkan siswa dan nilai untuk melihat peringkat</div>
                        </td>
                    </tr>
                `;
      }
    }

    // Render podium for top 3
    function renderPodium(topStudents) {
      const podiumContainer = document.getElementById('podiumContainer');
      podiumContainer.innerHTML = '';

      if (topStudents.length === 0) {
        podiumContainer.innerHTML = `
                    <div class="col-span-3 text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">
                            <svg class="w-20 h-20 mx-auto text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                        </div>
                        <div class="text-lg">Belum ada data peringkat</div>
                        <div class="text-sm">Tambahkan nilai siswa untuk melihat podium pemenang</div>
                    </div>
                `;
        return;
      }

      // For mobile (single column): show 1st, 2nd, 3rd in order
      // For desktop (3 columns): arrange as 2nd, 1st, 3rd for podium effect
      const isMobile = window.innerWidth < 640; // sm breakpoint

      const podiumOrder = isMobile ? [
        topStudents[0] || null, // 1st place (top on mobile)
        topStudents[1] || null, // 2nd place (middle on mobile)
        topStudents[2] || null // 3rd place (bottom on mobile)
      ] : [
        topStudents[1] || null, // 2nd place (left on desktop)
        topStudents[0] || null, // 1st place (center on desktop)
        topStudents[2] || null // 3rd place (right on desktop)
      ];

      const getMedalSVG = (position) => {
        if (isMobile) {
          // Mobile order: 1st, 2nd, 3rd
          if (position === 0) return '<div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-xl border-4 border-yellow-300">1</div>';
          if (position === 1) return '<div class="w-20 h-20 bg-gradient-to-br from-gray-300 to-gray-500 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-xl border-4 border-gray-200">2</div>';
          return '<div class="w-20 h-20 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-xl border-4 border-orange-300">3</div>';
        } else {
          // Desktop order: 2nd, 1st, 3rd
          if (position === 0) return '<div class="w-20 h-20 bg-gradient-to-br from-gray-300 to-gray-500 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-xl border-4 border-gray-200">2</div>';
          if (position === 1) return '<div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-xl border-4 border-yellow-300">1</div>';
          return '<div class="w-20 h-20 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-xl border-4 border-orange-300">3</div>';
        }
      };

      const heights = isMobile ? ['h-72', 'h-56', 'h-48'] : ['h-56', 'h-72', 'h-48'];
      const gradients = isMobile ? [
        'from-yellow-100 to-amber-200 border-yellow-400',
        'from-gray-100 to-gray-200 border-gray-300',
        'from-orange-100 to-orange-200 border-orange-300'
      ] : [
        'from-gray-100 to-gray-200 border-gray-300',
        'from-yellow-100 to-amber-200 border-yellow-400',
        'from-orange-100 to-orange-200 border-orange-300'
      ];
      const positions = isMobile ? ['1', '2', '3'] : ['2', '1', '3'];

      podiumOrder.forEach((student, index) => {
        if (!student) {
          podiumContainer.innerHTML += `
                        <div class="flex flex-col items-center">
                            <div class="bg-gradient-to-b ${gradients[index]} border-2 rounded-2xl p-6 w-full ${heights[index]} flex flex-col justify-center items-center opacity-50">
                                <div class="flex justify-center mb-2">${getMedalSVG(index)}</div>
                                <div class="text-sm text-gray-500">Posisi ${positions[index]}</div>
                                <div class="text-xs text-gray-400 mt-2">Belum ada</div>
                            </div>
                        </div>
                    `;
          return;
        }

        const gradeClass = getGradeClass(student.average);
        const gradeText = getGradeText(student.average);

        podiumContainer.innerHTML += `
                    <div class="flex flex-col items-center slide-in" style="animation-delay: ${index * 0.1}s">
                        <div class="mb-4 text-center">
                            <div class="flex justify-center mb-2">${getMedalSVG(index)}</div>
                            <div class="text-3xl font-bold text-gray-900">${student.average}</div>
                            <div class="text-sm ${gradeClass.replace('grade-', 'text-').replace('excellent', 'green-600').replace('good', 'blue-600').replace('fair', 'yellow-600').replace('poor', 'red-600')} font-semibold">
                                ${gradeText}
                            </div>
                        </div>
                        <div class="card-hover bg-gradient-to-b ${gradients[index]} border-2 rounded-2xl p-6 w-full ${heights[index]} flex flex-col justify-center items-center cursor-pointer" onclick="showDetailPanel(${student.siswaId})">
                            <div class="text-center">
                                <div class="text-5xl mb-3">
                                    <svg class="w-16 h-16 mx-auto text-gray-700" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="font-bold text-gray-900 text-lg mb-2">${student.nama}</div>
                                <div class="text-sm text-gray-600 mb-3">${student.kelas ? student.kelas.nama : 'Tidak ada'}</div>
                                <div class="text-xs text-gray-500 bg-white bg-opacity-50 px-3 py-1 rounded-full">
                                    Peringkat ${positions[index]}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
      });
    }

    // Update ranking kelas filter
    function updateRankingKelasFilter() {
      const filter = document.getElementById('rankingKelasFilter');
      const currentValue = filter.value;
      filter.innerHTML = '<option value="">üìö Semua Kelas</option>';
      data.kelas.forEach(kelas => {
        filter.innerHTML += `<option value="${kelas.id}">${kelas.nama}</option>`;
      });
      filter.value = currentValue;
    }

    function updateDashboardStats() {
      document.getElementById('dashTotalKelas').textContent = data.kelas.length;
      document.getElementById('dashTotalSiswa').textContent = data.siswa.length;

      let totalNilaiCount = 0;
      let totalNilaiSum = 0;

      data.nilai.forEach(nilai => {
        data.kolomNilai.forEach(kolom => {
          if (nilai[kolom.nama] !== undefined) {
            totalNilaiCount++;
            totalNilaiSum += parseFloat(nilai[kolom.nama]) || 0;
          }
        });
      });

      document.getElementById('dashTotalNilai').textContent = totalNilaiCount;
      document.getElementById('dashRataRata').textContent = totalNilaiCount > 0 ? (totalNilaiSum / totalNilaiCount).toFixed(1) : 0;
    }

    // Kelas Management
    function renderKelas() {
      const container = document.getElementById('kelasContainer');
      container.innerHTML = '';

      data.kelas.forEach(kelas => {
        const siswaCount = data.siswa.filter(s => s.kelasId === kelas.id).length;
        const card = document.createElement('div');
        card.className = 'card-hover bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-200 rounded-2xl p-6';
        card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-blue-900 mb-2">${kelas.nama}</h3>
                            <p class="text-sm text-blue-700">üéì Tingkat: ${kelas.tingkat}</p>
                            <p class="text-sm text-blue-700">üë®‚Äçüè´ Wali Kelas: ${kelas.waliKelas || '-'}</p>
                            <p class="text-sm text-blue-700">
                                <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                                </svg>
                                ${siswaCount} siswa
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editKelas(${kelas.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="hapusKelas(${kelas.id})" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-blue-200">
                        <div class="flex items-center justify-between text-sm text-blue-600">
                            <span>üìä Status: Aktif</span>
                            <span class="bg-blue-100 px-2 py-1 rounded-full text-xs">Semester ${data.currentSemester}</span>
                        </div>
                    </div>
                `;
        container.appendChild(card);
      });
    }

    function submitKelas(event) {
      event.preventDefault();
      const nama = document.getElementById('namaKelas').value;
      const tingkat = document.getElementById('tingkatKelas').value;
      const waliKelas = document.getElementById('waliKelas').value;
      const kelasId = document.getElementById('kelasId').value;

      if (kelasId) {
        // Edit existing kelas
        const kelas = data.kelas.find(k => k.id == kelasId);
        kelas.nama = nama;
        kelas.tingkat = tingkat;
        kelas.waliKelas = waliKelas;
        showNotification(`Kelas ${nama} berhasil diperbarui!`);
      } else {
        // Add new kelas
        const newId = Math.max(...data.kelas.map(k => k.id), 0) + 1;
        data.kelas.push({
          id: newId,
          nama,
          tingkat,
          waliKelas
        });
        showNotification(`Kelas ${nama} berhasil ditambahkan!`);
      }

      dataManager.saveData();
      closeModal('kelasModal');
      renderKelas();
      updateKelasFilters();
    }

    function editKelas(id) {
      const kelas = data.kelas.find(k => k.id === id);
      openModal('kelasModal', kelas);
    }

    function hapusKelas(id) {
      if (confirm('Yakin ingin menghapus kelas ini? Data siswa dan nilai akan ikut terhapus.')) {
        const kelas = data.kelas.find(k => k.id === id);
        data.kelas = data.kelas.filter(k => k.id !== id);
        data.siswa = data.siswa.filter(s => s.kelasId !== id);
        data.nilai = data.nilai.filter(n => {
          const siswa = data.siswa.find(s => s.id === n.siswaId);
          return siswa && siswa.kelasId !== id;
        });
        dataManager.saveData();
        renderKelas();
        updateKelasFilters();
        showNotification(`Kelas ${kelas.nama} berhasil dihapus!`);
      }
    }

    // Siswa Management
    function renderSiswa() {
      const tbody = document.getElementById('siswaTableBody');
      const kelasFilter = document.getElementById('kelasFilter').value;

      let filteredSiswa = data.siswa;
      if (kelasFilter) {
        filteredSiswa = data.siswa.filter(s => s.kelasId == kelasFilter);
      }

      tbody.innerHTML = '';
      filteredSiswa.forEach((siswa, index) => {
        const kelas = data.kelas.find(k => k.id === siswa.kelasId);
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${siswa.nama}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${kelas ? kelas.nama : 'Tidak ada'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="showDetailPanel(${siswa.id})" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-3 py-1.5 rounded-lg font-medium text-sm transition-all">
                                üîç Detail
                            </button>
                            <button onclick="editSiswa(${siswa.id})" class="text-blue-600 hover:text-blue-800 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition-colors text-sm">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="hapusSiswa(${siswa.id})" class="text-red-600 hover:text-red-800 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors text-sm">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </td>
                `;
        tbody.appendChild(row);
      });
    }

    function submitSiswa(event) {
      event.preventDefault();
      const nis = document.getElementById('nisSiswa').value;
      const nama = document.getElementById('namaSiswa').value;
      const kelasId = parseInt(document.getElementById('kelasSiswa').value);
      const siswaId = document.getElementById('siswaId').value;

      if (siswaId) {
        // Edit existing siswa
        const siswa = data.siswa.find(s => s.id == siswaId);
        siswa.nis = nis;
        siswa.nama = nama;
        siswa.kelasId = kelasId;
        showNotification(`Data siswa ${nama} berhasil diperbarui!`);
      } else {
        // Add new siswa
        const newId = Math.max(...data.siswa.map(s => s.id), 0) + 1;
        data.siswa.push({
          id: newId,
          nis,
          nama,
          kelasId
        });
        showNotification(`Siswa ${nama} berhasil ditambahkan!`);
      }

      dataManager.saveData();
      closeModal('siswaModal');
      renderSiswa();
    }

    function editSiswa(id) {
      const siswa = data.siswa.find(s => s.id === id);
      openModal('siswaModal', siswa);
    }

    function hapusSiswa(id) {
      if (confirm('Yakin ingin menghapus siswa ini? Data nilai akan ikut terhapus.')) {
        const siswa = data.siswa.find(s => s.id === id);
        data.siswa = data.siswa.filter(s => s.id !== id);
        data.nilai = data.nilai.filter(n => n.siswaId !== id);
        dataManager.saveData();
        renderSiswa();
        showNotification(`Siswa ${siswa.nama} berhasil dihapus!`);
      }
    }

    function downloadTemplateImport() {
      // Create template data
      const templateData = [
        ['NIS', 'Nama', 'Kelas'],
        ['2024001', 'Contoh Siswa 1', 'VII A'],
        ['2024002', 'Contoh Siswa 2', 'VII B'],
        ['2024003', 'Contoh Siswa 3', 'VIII A']
      ];

      // Add available classes info
      templateData.push([]);
      templateData.push(['Kelas yang tersedia:']);
      data.kelas.forEach(kelas => {
        templateData.push([kelas.nama]);
      });

      // Create workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(templateData);

      // Set column widths
      ws['!cols'] = [{
          wch: 12
        }, // NIS
        {
          wch: 25
        }, // Nama
        {
          wch: 15
        } // Kelas
      ];

      // Style header row
      ['A1', 'B1', 'C1'].forEach(cell => {
        if (ws[cell]) {
          ws[cell].s = {
            fill: {
              fgColor: {
                rgb: "4F81BD"
              }
            },
            font: {
              color: {
                rgb: "FFFFFF"
              },
              bold: true
            },
            alignment: {
              horizontal: "center",
              vertical: "center"
            }
          };
        }
      });

      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Template Import Siswa');

      // Download
      XLSX.writeFile(wb, 'Template_Import_Siswa.xlsx');

      showNotification('ÔøΩÔøΩÔøΩ Template berhasil diunduh! Isi data sesuai format lalu import kembali.', 'success');
    }

    function importSiswa() {
      // Create file input element
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls,.csv';

      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function(event) {
          try {
            let workbook;
            let worksheet;
            let jsonData;

            if (file.name.endsWith('.csv')) {
              // Handle CSV file
              const csvData = event.target.result;
              workbook = XLSX.read(csvData, {
                type: 'string'
              });
              worksheet = workbook.Sheets[workbook.SheetNames[0]];
              jsonData = XLSX.utils.sheet_to_json(worksheet);
            } else {
              // Handle Excel file
              const binaryData = event.target.result;
              workbook = XLSX.read(binaryData, {
                type: 'binary'
              });
              worksheet = workbook.Sheets[workbook.SheetNames[0]];
              jsonData = XLSX.utils.sheet_to_json(worksheet);
            }

            if (jsonData.length === 0) {
              showNotification('File tidak berisi data!', 'error');
              return;
            }

            // Process imported data
            let successCount = 0;
            let errorCount = 0;
            let duplicateCount = 0;
            const errors = [];

            jsonData.forEach((row, index) => {
              // Support various column name formats
              const nis = row['NIS'] || row['nis'] || row['Nis'] || row['NISN'] || row['nisn'] || '';
              const nama = row['Nama'] || row['nama'] || row['Nama Siswa'] || row['nama siswa'] || row['NAMA'] || '';
              const kelasNama = row['Kelas'] || row['kelas'] || row['KELAS'] || '';

              // Validation
              if (!nama || !kelasNama) {
                errorCount++;
                errors.push(`Baris ${index + 2}: Data Nama atau Kelas kosong`);
                return;
              }

              // Find kelas by name
              const kelas = data.kelas.find(k =>
                k.nama.toLowerCase() === kelasNama.toLowerCase()
              );

              if (!kelas) {
                errorCount++;
                errors.push(`Baris ${index + 2}: Kelas "${kelasNama}" tidak ditemukan`);
                return;
              }

              // Check for duplicate NIS
              if (nis && data.siswa.find(s => s.nis === nis.toString())) {
                duplicateCount++;
                errors.push(`Baris ${index + 2}: NIS "${nis}" sudah ada`);
                return;
              }

              // Add student
              const newId = Math.max(...data.siswa.map(s => s.id), 0) + 1;
              data.siswa.push({
                id: newId,
                nis: nis.toString(),
                nama: nama.toString(),
                kelasId: kelas.id
              });

              successCount++;
            });

            // Save data
            dataManager.saveData();
            renderSiswa();

            // Show result notification
            let message = `‚úÖ Berhasil import ${successCount} siswa`;
            if (duplicateCount > 0) {
              message += `, ${duplicateCount} duplikat diabaikan`;
            }
            if (errorCount > 0) {
              message += `, ${errorCount} error`;
            }

            showNotification(message, successCount > 0 ? 'success' : 'error');

            // Show detailed errors if any
            if (errors.length > 0 && errors.length <= 5) {
              setTimeout(() => {
                showNotification(errors.join(' | '), 'info');
              }, 3500);
            } else if (errors.length > 5) {
              setTimeout(() => {
                showNotification(`${errors.length} error ditemukan. Periksa format file Anda.`, 'info');
              }, 3500);
            }

          } catch (error) {
            console.error('Import error:', error);
            showNotification('Gagal membaca file! Pastikan format file benar.', 'error');
          }
        };

        // Read file based on type
        if (file.name.endsWith('.csv')) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
      };

      // Trigger file selection
      input.click();
    }

    // Nilai Management
    function renderNilai() {
      const kelasFilter = document.getElementById('kelasNilaiFilter').value;
      const semester = data.currentSemester;

      if (!kelasFilter) {
        document.getElementById('nilaiTableBody').innerHTML = `
                    <tr>
                        <td colspan="100" class="px-6 py-12 text-center text-gray-500">
                            <div class="text-4xl mb-4">üìö</div>
                            <div class="text-lg">Pilih kelas terlebih dahulu</div>
                        </td>
                    </tr>
                `;
        return;
      }

      // Update header
      const header = document.getElementById('nilaiTableHeader');
      header.innerHTML = '<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Nama Siswa</th>';

      // Add column headers
      data.kolomNilai.forEach(kolom => {
        header.innerHTML += `
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <div class="flex flex-col gap-2">
                            <div>
                                <div>${kolom.nama}</div>
                                <div class="text-xs text-gray-400 font-normal">${kolom.tanggal}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editKolom('${kolom.nama}')" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors" title="Edit kolom">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                    </svg>
                                </button>
                                <button onclick="hapusKolom('${kolom.nama}')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors" title="Hapus kolom">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </th>
                `;
      });

      header.innerHTML += '<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Nilai</th>';
      header.innerHTML += '<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Akhir (%)</th>';

      // Render body
      const tbody = document.getElementById('nilaiTableBody');
      const siswaList = data.siswa.filter(s => s.kelasId == kelasFilter);

      tbody.innerHTML = '';
      siswaList.forEach(siswa => {
        let nilaiRecord = data.nilai.find(n => n.siswaId === siswa.id && n.semester === semester);

        if (!nilaiRecord) {
          nilaiRecord = {
            siswaId: siswa.id,
            semester: semester
          };
          data.nilai.push(nilaiRecord);
        }

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900 sticky left-0 bg-white">${siswa.nama}</td>`;

        // Add value inputs
        data.kolomNilai.forEach(kolom => {
          const nilai = nilaiRecord[kolom.nama] !== undefined ? nilaiRecord[kolom.nama] : '';
          row.innerHTML += `
                        <td class="px-6 py-4">
                            <input type="number" 
                                   min="0" 
                                   max="100" 
                                   value="${nilai}"
                                   placeholder="0-100"
                                   onchange="updateNilai(${siswa.id}, '${kolom.nama}', this.value)"
                                   class="input-field w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    `;
        });

        // Calculate total and final grade
        let totalNilai = 0;
        let jumlahKolom = 0;

        data.kolomNilai.forEach(kolom => {
          if (nilaiRecord[kolom.nama] !== undefined) {
            totalNilai += parseFloat(nilaiRecord[kolom.nama]) || 0;
            jumlahKolom++;
          }
        });

        const average = calculateStudentAverage(siswa.id);
        const gradeClass = getGradeClass(average);

        row.innerHTML += `
                    <td class="px-6 py-4">
                        <span class="bg-purple-100 text-purple-800 px-3 py-1.5 rounded-lg font-bold text-lg border border-purple-300">
                            ${Math.round(totalNilai)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="${gradeClass} px-3 py-1.5 rounded-lg font-bold text-lg">
                            ${average}
                        </span>
                    </td>
                `;

        tbody.appendChild(row);
      });

      if (siswaList.length === 0) {
        tbody.innerHTML = `
                    <tr>
                        <td colspan="100" class="px-6 py-12 text-center text-gray-500">
                            <div class="text-4xl mb-4">
                                <svg class="w-16 h-16 mx-auto text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                                </svg>
                            </div>
                            <div class="text-lg">Tidak ada siswa di kelas ini</div>
                        </td>
                    </tr>
                `;
      }
    }

    function updateNilai(siswaId, kolomNama, nilai) {
      const semester = data.currentSemester;
      let nilaiRecord = data.nilai.find(n => n.siswaId === siswaId && n.semester === semester);

      if (!nilaiRecord) {
        nilaiRecord = {
          siswaId: siswaId,
          semester: semester,
          tanggal: new Date().toISOString().split('T')[0]
        };
        data.nilai.push(nilaiRecord);
      }

      nilaiRecord[kolomNama] = parseFloat(nilai) || 0;
      nilaiRecord.tanggal = new Date().toISOString().split('T')[0];

      dataManager.saveData();
      renderNilai();
    }

    function submitKolom(event) {
      event.preventDefault();
      const nama = document.getElementById('namaKolom').value;
      const tanggal = document.getElementById('tanggalKolom').value;
      const oldNama = document.getElementById('oldKolomNama').value;

      if (oldNama) {
        // Edit existing column
        // Check if new name already exists (but not the old name)
        if (oldNama !== nama && data.kolomNilai.find(k => k.nama === nama)) {
          showNotification('Kolom dengan nama ini sudah ada!', 'error');
          return;
        }

        // Update column name
        const kolom = data.kolomNilai.find(k => k.nama === oldNama);
        if (kolom) {
          kolom.nama = nama;
          kolom.tanggal = tanggal;

          // Update all nilai records with new column name
          if (oldNama !== nama) {
            data.nilai.forEach(n => {
              if (n[oldNama] !== undefined) {
                n[nama] = n[oldNama];
                delete n[oldNama];
              }
            });
          }

          showNotification(`Kolom "${oldNama}" berhasil diperbarui menjadi "${nama}"!`);
        }
      } else {
        // Add new column
        // Check if column already exists
        if (data.kolomNilai.find(k => k.nama === nama)) {
          showNotification('Kolom dengan nama ini sudah ada!', 'error');
          return;
        }

        data.kolomNilai.push({
          nama,
          tanggal
        });
        showNotification(`Kolom ${nama} berhasil ditambahkan!`);
      }

      dataManager.saveData();
      closeModal('kolomModal');
      renderNilai();
      updateFilterOptions();
    }

    function editKolom(namaKolom) {
      const kolom = data.kolomNilai.find(k => k.nama === namaKolom);
      if (!kolom) return;

      // Open modal and populate form
      document.getElementById('kolomModalTitle').textContent = 'Edit Kolom Nilai';
      document.getElementById('oldKolomNama').value = namaKolom;
      document.getElementById('namaKolom').value = kolom.nama;
      document.getElementById('tanggalKolom').value = kolom.tanggal;
      document.getElementById('kolomSubmitBtn').innerHTML = '‚úèÔ∏è Update Kolom';

      updateFormProgress('kolom');

      const modal = document.getElementById('kolomModal');
      modal.classList.add('show');
    }

    function hapusKolom(namaKolom) {
      if (confirm(`Yakin ingin menghapus kolom "${namaKolom}"? Data nilai akan ikut terhapus.`)) {
        data.kolomNilai = data.kolomNilai.filter(k => k.nama !== namaKolom);

        // Remove column data from all nilai records
        data.nilai.forEach(n => {
          delete n[namaKolom];
        });

        dataManager.saveData();
        renderNilai();
        updateFilterOptions();
        showNotification(`Kolom ${namaKolom} berhasil dihapus!`);
      }
    }

    // Grade classification helpers
    function getGradeClass(nilai) {
      if (nilai >= 90) return 'grade-excellent';
      if (nilai >= 80) return 'grade-good';
      if (nilai >= 75) return 'grade-fair';
      return 'grade-poor';
    }

    function getGradeText(nilai) {
      if (nilai >= 90) return '‚≠ê Sangat Baik';
      if (nilai >= 80) return 'üëç Baik';
      if (nilai >= 75) return '‚ö†Ô∏è Cukup';
      return 'üìâ Perlu Perbaikan';
    }

    // Filter functionality
    function updateFilterOptions() {
      // Update kelas filter
      const filterKelas = document.getElementById('filterKelas');
      const currentKelas = filterKelas.value;
      filterKelas.innerHTML = '<option value="">Semua Kelas</option>';
      data.kelas.forEach(kelas => {
        filterKelas.innerHTML += `<option value="${kelas.id}">${kelas.nama}</option>`;
      });
      filterKelas.value = currentKelas;

      // Update jenis nilai filter
      const filterJenisNilai = document.getElementById('filterJenisNilai');
      const currentJenis = filterJenisNilai.value;
      filterJenisNilai.innerHTML = '<option value="">Semua Jenis</option>';
      data.kolomNilai.forEach(kolom => {
        filterJenisNilai.innerHTML += `<option value="${kolom.nama}">${kolom.nama}</option>`;
      });
      filterJenisNilai.value = currentJenis;
    }

    function applyFilter() {
      const tanggalMulai = document.getElementById('tanggalMulai').value;
      const tanggalAkhir = document.getElementById('tanggalAkhir').value;
      const namaSiswa = document.getElementById('filterNamaSiswa').value.toLowerCase();
      const kelasId = document.getElementById('filterKelas').value;
      const jenisNilai = document.getElementById('filterJenisNilai').value;

      let filteredSiswa = data.siswa;

      // Filter by kelas
      if (kelasId) {
        filteredSiswa = filteredSiswa.filter(s => s.kelasId == kelasId);
      }

      // Filter by nama
      if (namaSiswa) {
        filteredSiswa = filteredSiswa.filter(s => s.nama.toLowerCase().includes(namaSiswa));
      }

      // Filter by date and jenis nilai
      const results = filteredSiswa.map(siswa => {
        const kelas = data.kelas.find(k => k.id === siswa.kelasId);
        const nilai = data.nilai.find(n => n.siswaId === siswa.id && n.semester === data.currentSemester);

        if (!nilai) return null;

        // Check date filter
        if (tanggalMulai && nilai.tanggal < tanggalMulai) return null;
        if (tanggalAkhir && nilai.tanggal > tanggalAkhir) return null;

        // Check jenis nilai filter
        if (jenisNilai && (nilai[jenisNilai] === undefined || nilai[jenisNilai] === null)) return null;

        return {
          siswa,
          kelas,
          nilai,
          average: calculateStudentAverage(siswa.id)
        };
      }).filter(r => r !== null);

      // Render results
      const tbody = document.getElementById('filterTableBody');
      tbody.innerHTML = '';

      results.forEach(result => {
        const gradeClass = getGradeClass(result.average);

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${result.siswa.nama}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${result.kelas ? result.kelas.nama : 'Tidak ada'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${data.currentSemester === 'ganjil' ? 'üåô Ganjil' : '‚òÄÔ∏è Genap'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="${gradeClass} px-3 py-1.5 rounded-lg font-bold">
                            ${result.average}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="showDetailPanel(${result.siswa.id})" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-3 py-1.5 rounded-lg font-medium text-sm transition-all">
                            üîç Lihat Detail
                        </button>
                    </td>
                `;
        tbody.appendChild(row);
      });

      if (results.length === 0) {
        tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            <div class="text-4xl mb-4">üîç</div>
                            <div class="text-lg">Tidak ada data yang sesuai dengan filter</div>
                        </td>
                    </tr>
                `;
      }

      document.getElementById('filterResults').classList.remove('hidden');
      showNotification(`Ditemukan ${results.length} hasil`, 'info');
    }

    // Export functionality
    function updateStatistics() {
      document.getElementById('totalKelas').textContent = data.kelas.length;
      document.getElementById('totalSiswa').textContent = data.siswa.length;

      let totalNilaiCount = 0;
      let totalNilaiSum = 0;

      data.nilai.forEach(nilai => {
        data.kolomNilai.forEach(kolom => {
          if (nilai[kolom.nama] !== undefined) {
            totalNilaiCount++;
            totalNilaiSum += parseFloat(nilai[kolom.nama]) || 0;
          }
        });
      });

      document.getElementById('totalNilai').textContent = totalNilaiCount;
      document.getElementById('rataRata').textContent = totalNilaiCount > 0 ? (totalNilaiSum / totalNilaiCount).toFixed(1) : 0;
    }

    function updateExportOptions() {
      // Update export kelas select
      const exportKelasSelect = document.getElementById('exportKelasSelect');
      const currentValue = exportKelasSelect.value;
      exportKelasSelect.innerHTML = '<option value="">üìö Semua Kelas</option>';
      data.kelas.forEach(kelas => {
        exportKelasSelect.innerHTML += `<option value="${kelas.id}">${kelas.nama}</option>`;
      });
      exportKelasSelect.value = currentValue;

      // Update export nilai checkboxes
      const checkboxContainer = document.getElementById('exportNilaiCheckboxes');
      checkboxContainer.innerHTML = '';

      if (data.kolomNilai.length === 0) {
        checkboxContainer.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">Belum ada jenis nilai</div>';
      } else {
        data.kolomNilai.forEach(kolom => {
          const checkbox = document.createElement('label');
          checkbox.className = 'flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded-lg';
          checkbox.innerHTML = `
                        <input type="checkbox" value="${kolom.nama}" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm text-gray-700">${kolom.nama} (${kolom.tanggal})</span>
                    `;
          checkboxContainer.appendChild(checkbox);
        });
      }
    }

    function exportRankingExcel() {
      const kelasFilter = document.getElementById('exportKelasSelect').value;
      const tahunAjaran = document.getElementById('exportTahunAjaran').value;
      const sortType = document.getElementById('exportSortType').value;
      const judulLaporan = document.getElementById('exportJudulLaporan').value;
      const tambahNIS = document.getElementById('exportTambahNIS').checked;

      // Get selected nilai types
      const selectedNilai = Array.from(document.querySelectorAll('#exportNilaiCheckboxes input:checked')).map(cb => cb.value);

      if (selectedNilai.length === 0) {
        showNotification('Pilih minimal satu jenis nilai!', 'error');
        return;
      }

      let students = getRankedStudents(kelasFilter);

      // Sort based on type
      if (sortType === 'abjad') {
        students.sort((a, b) => a.nama.localeCompare(b.nama));
      }

      // Prepare data
      const headers = ['No'];
      if (tambahNIS) headers.push('NIS');
      headers.push('Nama Siswa', 'Kelas');
      selectedNilai.forEach(n => headers.push(n));
      headers.push('Rata-rata', 'Keterangan');

      const rows = [headers];

      students.forEach((student, index) => {
        const siswaData = data.siswa.find(s => s.id === student.siswaId);
        const nilai = data.nilai.find(n => n.siswaId === student.siswaId && n.semester === data.currentSemester);

        const row = [index + 1];
        if (tambahNIS) row.push(siswaData.nis || '-');
        row.push(student.nama, student.kelas ? student.kelas.nama : '-');

        selectedNilai.forEach(kolom => {
          row.push(nilai && nilai[kolom] !== undefined ? nilai[kolom] : 0);
        });

        row.push(student.average, getGradeText(student.average));
        rows.push(row);
      });

      // Create workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);

      // Add title rows
      XLSX.utils.sheet_add_aoa(ws, [
        [judulLaporan],
        [`Tahun Ajaran: ${tahunAjaran}`],
        [`Semester: ${data.currentSemester === 'ganjil' ? 'Ganjil' : 'Genap'}`],
        [`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`],
        []
      ], {
        origin: 'A1'
      });

      // Merge title cell
      ws['!merges'] = [{
        s: {
          r: 0,
          c: 0
        },
        e: {
          r: 0,
          c: headers.length - 1
        }
      }];

      // Set column widths
      const colWidths = [{
        wch: 5
      }];
      if (tambahNIS) colWidths.push({
        wch: 12
      });
      colWidths.push({
        wch: 25
      }, {
        wch: 12
      });
      selectedNilai.forEach(() => colWidths.push({
        wch: 12
      }));
      colWidths.push({
        wch: 12
      }, {
        wch: 20
      });
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, 'Ranking Siswa');

      const filename = `Ranking_${judulLaporan.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, filename);

      showNotification('üìä File Excel berhasil diunduh!', 'success');
    }

    function exportRankingCSV() {
      const kelasFilter = document.getElementById('exportKelasSelect').value;
      const sortType = document.getElementById('exportSortType').value;
      const judulLaporan = document.getElementById('exportJudulLaporan').value;
      const tambahNIS = document.getElementById('exportTambahNIS').checked;

      // Get selected nilai types
      const selectedNilai = Array.from(document.querySelectorAll('#exportNilaiCheckboxes input:checked')).map(cb => cb.value);

      if (selectedNilai.length === 0) {
        showNotification('Pilih minimal satu jenis nilai!', 'error');
        return;
      }

      let students = getRankedStudents(kelasFilter);

      // Sort based on type
      if (sortType === 'abjad') {
        students.sort((a, b) => a.nama.localeCompare(b.nama));
      }

      // Prepare CSV content
      const headers = ['No'];
      if (tambahNIS) headers.push('NIS');
      headers.push('Nama Siswa', 'Kelas');
      selectedNilai.forEach(n => headers.push(n));
      headers.push('Rata-rata', 'Keterangan');

      let csv = headers.join(',') + '\n';

      students.forEach((student, index) => {
        const siswaData = data.siswa.find(s => s.id === student.siswaId);
        const nilai = data.nilai.find(n => n.siswaId === student.siswaId && n.semester === data.currentSemester);

        const row = [index + 1];
        if (tambahNIS) row.push(siswaData.nis || '-');
        row.push(`"${student.nama}"`, student.kelas ? student.kelas.nama : '-');

        selectedNilai.forEach(kolom => {
          row.push(nilai && nilai[kolom] !== undefined ? nilai[kolom] : 0);
        });

        row.push(student.average, `"${getGradeText(student.average)}"`);
        csv += row.join(',') + '\n';
      });

      // Download CSV
      const blob = new Blob([csv], {
        type: 'text/csv;charset=utf-8;'
      });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `Ranking_${judulLaporan.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      showNotification('üìã File CSV berhasil diunduh!', 'success');
    }

    function eksporExcel() {
      const wb = XLSX.utils.book_new();

      // Create summary sheet
      const summaryData = [
        ['LAPORAN NILAI SISWA'],
        ['Tahun Ajaran: 2023/2024'],
        [`Semester: ${data.currentSemester === 'ganjil' ? 'Ganjil' : 'Genap'}`],
        [],
        ['Ringkasan'],
        ['Total Kelas', data.kelas.length],
        ['Total Siswa', data.siswa.length],
        ['Total Jenis Nilai', data.kolomNilai.length]
      ];

      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summarySheet, 'Ringkasan');

      // Create sheet per kelas
      data.kelas.forEach(kelas => {
        const siswaList = data.siswa.filter(s => s.kelasId === kelas.id);

        const headers = ['No', 'NIS', 'Nama Siswa'];
        data.kolomNilai.forEach(kolom => headers.push(kolom.nama));
        headers.push('Rata-rata');

        const kelasData = [headers];

        siswaList.forEach((siswa, index) => {
          const nilai = data.nilai.find(n => n.siswaId === siswa.id && n.semester === data.currentSemester);
          const row = [index + 1, siswa.nis || '-', siswa.nama];

          data.kolomNilai.forEach(kolom => {
            row.push(nilai && nilai[kolom.nama] !== undefined ? nilai[kolom.nama] : 0);
          });

          row.push(calculateStudentAverage(siswa.id));
          kelasData.push(row);
        });

        const ws = XLSX.utils.aoa_to_sheet(kelasData);
        XLSX.utils.book_append_sheet(wb, ws, kelas.nama.replace(/[\/\\?*\[\]]/g, ''));
      });

      // Download
      XLSX.writeFile(wb, `Laporan_Nilai_Lengkap_${new Date().toISOString().split('T')[0]}.xlsx`);
      showNotification('üì• File Excel lengkap berhasil diunduh!', 'success');
    }

    function eksporCSV() {
      let csv = 'Kelas,NIS,Nama Siswa';
      data.kolomNilai.forEach(kolom => {
        csv += `,${kolom.nama}`;
      });
      csv += ',Rata-rata,Semester\n';

      data.siswa.forEach(siswa => {
        const kelas = data.kelas.find(k => k.id === siswa.kelasId);
        const nilai = data.nilai.find(n => n.siswaId === siswa.id && n.semester === data.currentSemester);

        csv += `${kelas ? kelas.nama : '-'},${siswa.nis || '-'},"${siswa.nama}"`;

        data.kolomNilai.forEach(kolom => {
          csv += `,${nilai && nilai[kolom.nama] !== undefined ? nilai[kolom.nama] : 0}`;
        });

        csv += `,${calculateStudentAverage(siswa.id)},${data.currentSemester}\n`;
      });

      const blob = new Blob([csv], {
        type: 'text/csv;charset=utf-8;'
      });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `Laporan_Nilai_CSV_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      showNotification('üì• File CSV berhasil diunduh!', 'success');
    }

    // Update kelas filters
    function updateKelasFilters() {
      // Update siswa kelas filter
      const kelasFilter = document.getElementById('kelasFilter');
      if (kelasFilter) {
        const currentValue = kelasFilter.value;
        kelasFilter.innerHTML = '<option value="">üìö Semua Kelas</option>';
        data.kelas.forEach(kelas => {
          kelasFilter.innerHTML += `<option value="${kelas.id}">${kelas.nama}</option>`;
        });
        kelasFilter.value = currentValue;
      }

      // Update nilai kelas filter
      const kelasNilaiFilter = document.getElementById('kelasNilaiFilter');
      if (kelasNilaiFilter) {
        const currentValue = kelasNilaiFilter.value;
        kelasNilaiFilter.innerHTML = '<option value="">üìö Pilih Kelas</option>';
        data.kelas.forEach(kelas => {
          kelasNilaiFilter.innerHTML += `<option value="${kelas.id}">${kelas.nama}</option>`;
        });
        kelasNilaiFilter.value = currentValue;
      }
    }
  </script>
  <script>
    (function() {
      function c() {
        var b = a.contentDocument || a.contentWindow.document;
        if (b) {
          var d = b.createElement('script');
          d.innerHTML = "window.__CF$cv$params={r:'9aad5bfa428bab59',t:'MTc2NTIwODQwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
          b.getElementsByTagName('head')[0].appendChild(d)
        }
      }
      if (document.body) {
        var a = document.createElement('iframe');
        a.height = 1;
        a.width = 1;
        a.style.position = 'absolute';
        a.style.top = 0;
        a.style.left = 0;
        a.style.border = 'none';
        a.style.visibility = 'hidden';
        document.body.appendChild(a);
        if ('loading' !== document.readyState) c();
        else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c);
        else {
          var e = document.onreadystatechange || function() {};
          document.onreadystatechange = function(b) {
            e(b);
            'loading' !== document.readyState && (document.onreadystatechange = e, c())
          }
        }
      }
    })();
  </script>
</body>

</html>